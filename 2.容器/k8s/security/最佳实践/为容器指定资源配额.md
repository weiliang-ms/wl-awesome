# Resource policies

## æ¼æ´è§£æ

> æ¼æ´æ‰«ææ ·ä¾‹

```
[control: Resource policies] failed ğŸ˜¥
Description: CPU and memory resources should have a limit set for every container to prevent resource exhaustion.
   Namespace security
      Deployment - nginx
Summary - Passed:0   Warning:0   Failed:1   Total:1
Remediation: Define LimitRange and ResourceQuota policies to limit resource usage for namespaces or nodes.
```

> æè¿°: åº”è¯¥ä¸ºæ¯ä¸ªå®¹å™¨è®¾ç½®`CPU`å’Œå†…å­˜èµ„æºçš„é™åˆ¶ï¼Œä»¥é˜²æ­¢èµ„æºè€—å°½ã€‚

## åŠ å›ºæ–¹æ¡ˆ

### 1.ä¸ºnamespaceé…ç½®LimitRange

> åŸç†æè¿°ï¼š

åŸºäºå‘½åç©ºé—´åˆ›å»ºå…¨å±€ç¼ºçœé…é¢ï¼Œä¿è¯å®¹å™¨å­˜åœ¨é»˜è®¤é…é¢ï¼Œé¿å…å¼‚å¸¸èµ„æºå ç”¨ï¼ˆå¦‚ï¼šæ­»å¾ªç¯å¯¼è‡´çš„é«˜`CPU`å ç”¨ï¼‰å®¹å™¨å½±å“åŒä¸€`worker`èŠ‚ç‚¹ä¸Šå…¶ä»–å®¹å™¨æ­£å¸¸è¿è¡Œï¼Œè¿›è€Œæå‡ç³»ç»Ÿæ•´ç†ç¨³å®šæ€§ã€‚

> é…ç½®æ ·ä¾‹:

1. åˆ›å»ºä¸€ä¸ª`namespace`:

```shell
$ kubectl create ns security
```

2. ä¸º`namespace`ä¸‹å®¹å™¨åˆ›å»ºç¼ºçœé…é¢:

```shell
$ cat <<EOF | kubectl apply -n security -f -
apiVersion: v1
kind: LimitRange
metadata:
  name: default-limit-range
spec:
  limits:
  - default:
      memory: 512Mi
      cpu: 0.5
    defaultRequest:
      memory: 256Mi
      cpu: 0.2
    type: Container
EOF
```

3. åˆ›å»ºæ ·ä¾‹åº”ç”¨:

```shell
$ cat <<EOF | kubectl apply -n security -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
EOF
```

4. æŸ¥çœ‹`pod`:

```shell
$ kubectl describe pod -n security -l app=nginx |grep -C 3 Requests
    Limits:
      cpu:     500m
      memory:  512Mi
    Requests:
      cpu:        200m
      memory:     256Mi
    Environment:  <none>
```

è¯æ˜ç¼ºçœé…é¢ç”Ÿæ•ˆã€‚

æ­¤æ—¶`kubescape`é‡æ–°æ‰«æåå‘ç°ï¼Œ`security`ä¾ç„¶å­˜åœ¨æ¼æ´

```
[control: Resource policies] failed ğŸ˜¥
Description: CPU and memory resources should have a limit set for every container to prevent resource exhaustion.
   Namespace security
      LimitRange - default-limit-range
Summary - Passed:1   Warning:0   Failed:1   Total:2
Remediation: Define LimitRange and ResourceQuota policies to limit resource usage for namespaces or nodes.
```

### 2.ä¸ºnamespaceé…ç½®ResourceQuota

> åŸç†æè¿°ï¼š

åŸºäºå‘½åç©ºé—´åˆ›å»ºé…é¢æ€»é¢ï¼Œåˆ©ç”¨`ResourceQuota`é™åˆ¶å‘½åç©ºé—´ä¸­æ‰€æœ‰å®¹å™¨çš„å†…å­˜è¯·æ±‚æ€»é‡ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥é™åˆ¶å†…å­˜é™åˆ¶æ€»é‡ã€`CPU`è¯·æ±‚æ€»é‡ã€`CPU`é™åˆ¶æ€»é‡ã€‚

> é…ç½®æ ·ä¾‹:

1. ä¸º`security`å‘½åç©ºé—´åˆ›å»ºé…é¢:

```shell
$ cat <<EOF | kubectl apply -n security -f -
apiVersion: v1
kind: ResourceQuota
metadata:
  name: ns-resource-quota
spec:
  hard:
    requests.cpu: "1"
    requests.memory: 1Gi
    limits.cpu: "2"
    limits.memory: 2Gi
EOF
```

`ResourceQuota`åœ¨`security`å‘½åç©ºé—´ä¸­è®¾ç½®äº†å¦‚ä¸‹è¦æ±‚ï¼š

- æ¯ä¸ªå®¹å™¨å¿…é¡»æœ‰å†…å­˜è¯·æ±‚å’Œé™åˆ¶ï¼Œä»¥åŠ`CPU`è¯·æ±‚å’Œé™åˆ¶ã€‚
- æ‰€æœ‰å®¹å™¨çš„å†…å­˜è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡`1 GiB`
- æ‰€æœ‰å®¹å™¨çš„å†…å­˜é™åˆ¶æ€»å’Œä¸èƒ½è¶…è¿‡`2 GiB`
- æ‰€æœ‰å®¹å™¨çš„`CPU`è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡`1 cpu`
- æ‰€æœ‰å®¹å™¨çš„`CPU`é™åˆ¶æ€»å’Œä¸èƒ½è¶…è¿‡`2 cpu`

### 3.ä¸ºå®¹å™¨æ·»åŠ é…é¢

> åŸç†æè¿°ï¼š

ä¸ºä¸åŒå®¹å™¨æ˜¾ç¤ºé…ç½®åˆé€‚çš„é…é¢ï¼Œè€Œä¸ä½¿ç”¨ç¼ºçœå€¼ï¼Œå¯ä»¥æ›´åˆç†çš„ç®¡ç†èµ„æº

> é…ç½®æ ·ä¾‹:

1. åˆ é™¤å‰é¢æ­¥éª¤ä¸­åˆ›å»ºçš„`Deployment`å¯¹è±¡

```shell
$ kubectl delete -n security Deployment/nginx
deployment.apps "nginx" deleted
```

2. åˆ›å»ºæ ·ä¾‹åº”ç”¨:

```shell
$ cat <<EOF | kubectl apply -n security -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 500m
            memory: 512Mi
EOF
```

æ­¤æ—¶`kubescape`é‡æ–°æ‰«æåå‘ç°ï¼Œ`security`ä¾ç„¶å­˜åœ¨æ¼æ´

```
[control: Resource policies] failed ğŸ˜¥
Description: CPU and memory resources should have a limit set for every container to prevent resource exhaustion.
   Namespace security
      LimitRange - default-limit-range
Summary - Passed:2   Warning:0   Failed:1   Total:3
Remediation: Define LimitRange and ResourceQuota policies to limit resource usage for namespaces or nodes.
```

æ€€ç–‘ä¸º`kubescape`çš„`bug`

### æ€»ç»“

é€šè¿‡ä¸‰ç§æ–¹å¼å¯¹èµ„æºé…é¢è¿›è¡ŒåŠ å›º:

1. `LimitRange`
2. `ResourceQuota`
3. å®¹å™¨çš„`resources`å­—æ®µ

å…¶ä¸­ï¼Œ`LimitRange`ä¸ºå¿…éœ€æ–¹æ¡ˆï¼Œä¿è¯å‘½åç©ºé—´ä¸‹çš„å®¹å™¨æœ‰ä¸€ä¸ªç¼ºçœé…é¢ã€‚`ResourceQuota`ä¸ºæ¨èæ–¹æ¡ˆï¼Œéå¿…é¡»ã€‚

è€Œä¸ºæ¯ä¸ªå®¹å™¨æ˜¾ç¤ºè®¾ç½®é…é¢ä¸ºå¼ºçƒˆæ¨èæ–¹æ¡ˆã€‚
